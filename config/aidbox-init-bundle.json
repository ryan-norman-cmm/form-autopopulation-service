{
  "resourceType": "Bundle",
  "id": "form-auto-population-init-bundle",
  "type": "transaction",
  "entry": [
    {
      "request": {
        "method": "PUT",
        "url": "Client/form-auto-population-service"
      },
      "resource": {
        "resourceType": "Client",
        "id": "form-auto-population-service",
        "secret": "{{FORM_AUTOPOPULATION_CLIENT_SECRET}}",
        "grant_types": ["client_credentials"],
        "scope": [
          "system/Patient.read",
          "system/Questionnaire.*",
          "system/QuestionnaireResponse.*",
          "system/Subscription.*"
        ]
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/questionnaire-access-policy"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "questionnaire-access-policy",
        "description": "Allow form-auto-population-service to access Questionnaire resources",
        "engine": "sql",
        "sql": {
          "query": "SELECT true WHERE request.params.resource/type = 'Questionnaire'"
        },
        "link": [
          {
            "resourceType": "Client",
            "id": "form-auto-population-service"
          }
        ]
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/questionnaireresponse-access-policy"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "questionnaireresponse-access-policy",
        "description": "Allow form-auto-population-service to access QuestionnaireResponse resources",
        "engine": "sql",
        "sql": {
          "query": "SELECT true WHERE request.params.resource/type = 'QuestionnaireResponse'"
        },
        "link": [
          {
            "resourceType": "Client",
            "id": "form-auto-population-service"
          }
        ]
      }
    },
    {
      "request": {
        "method": "PUT",
        "url": "AccessPolicy/subscription-access-policy"
      },
      "resource": {
        "resourceType": "AccessPolicy",
        "id": "subscription-access-policy",
        "description": "Allow form-auto-population-service to access Subscription resources",
        "engine": "sql",
        "sql": {
          "query": "SELECT true WHERE request.params.resource/type = 'Subscription'"
        },
        "link": [
          {
            "resourceType": "Client",
            "id": "form-auto-population-service"
          }
        ]
      }
    },
    {
      "request": {
        "method": "POST",
        "url": "AidboxSubscriptionTopic"
      },
      "resource": {
        "resourceType": "AidboxSubscriptionTopic",
        "id": "questionnaire-response-topic",
        "url": "http://example.org/FHIR/R5/SubscriptionTopic/QuestionnaireResponse-topic",
        "status": "active",
        "trigger": [
          {
            "resource": "QuestionnaireResponse",
            "fhirPathCriteria": "status = 'completed' or status = 'amended'"
          }
        ]
      }
    },
    {
      "request": {
        "method": "POST",
        "url": "AidboxTopicDestination"
      },
      "resource": {
        "resourceType": "AidboxTopicDestination",
        "meta": {
          "profile": [
            "http://aidbox.app/StructureDefinition/aidboxtopicdestination-kafka-best-effort"
          ]
        },
        "kind": "kafka-best-effort",
        "id": "kafka-destination",
        "topic": "http://example.org/FHIR/R5/SubscriptionTopic/QuestionnaireResponse-topic",
        "parameter": [
          {
            "name": "kafkaTopic",
            "valueString": "{{FORM_POPULATION_COMPLETED_TOPIC}}"
          },
          {
            "name": "bootstrapServers",
            "valueString": "{{KAFKA_INTERNAL_HOST}}:{{KAFKA_INTERNAL_PORT}}"
          }
        ]
      }
    }
  ]
}
